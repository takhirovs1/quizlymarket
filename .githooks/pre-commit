#!/usr/bin/env bash
# This script runs before each commit to ensure that all staged dart files are
# formatted and that there are no issues found by flutter analyze.

set -euo pipefail

# Hook metadata
HOOK_VERSION="1.0.3"
HOOK_NAME="pre-commit"
MINIMUM_DART_VERSION="3.0.0"
MINIMUM_FLUTTER_VERSION="3.13.0"

# Colors for output
PRC='\033[33;1m' # Process - yellow
SCC='\033[32;1m' # Success - green
ERR='\033[31;1m' # Error - red
NC='\033[0m'     # No color

# Function to print colored messages
log() {
    echo -e "${2:-$PRC}$1${NC}\n"
}

# Check if dart is available
if ! command -v dart >/dev/null 2>&1; then
    log "Dart command not found. Please ensure Dart is installed and in your PATH." "$ERR"
    exit 1
fi

# Check if flutter is available
if ! command -v flutter >/dev/null 2>&1; then
    log "Flutter command not found. Please ensure Flutter is installed and in your PATH." "$ERR"
    exit 1
fi

log "üì¶ Running ${HOOK_NAME} hook v${HOOK_VERSION}"

# Get all staged dart files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM "*.dart" | tr '\n' ' ')

# Early exit if no Dart files are staged
if [ -z "$STAGED_FILES" ]; then
    log "No Dart files to check, proceeding with commit." "$SCC"
    exit 0
fi

if [ -n "$STAGED_FILES" ]; then
    log "üõ† Formatting staged files..."

    # Check if files exist (in case they were deleted)
    for file in $STAGED_FILES; do
        if [ ! -f "$file" ]; then
            continue
        fi

        # Format each file individually to better handle errors
        if ! dart format -l 120 "$file"; then
            log "Failed to format $file" "$ERR"
            exit 1
        fi
        git add "$file"
    done

    log "üîç Running flutter analyze..."
    if ! flutter analyze; then
        log "‚ùå Flutter analyze found issues, please fix them before committing!" "$ERR"
        exit 1
    fi
fi

# Check if there are staged changes
if git diff --cached --quiet; then
    log "‚ùå No changes to commit." "$ERR"
    exit 1
fi

log "‚úÖ All checks passed. Proceeding with commit." "$SCC"
exit 0
